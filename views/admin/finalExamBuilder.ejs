<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= pageTitle %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="stylesheet" href="/css/adminDashboard.css" />
</head>

<body class="bg-[#fffaf4] text-[#4a2e05] min-h-screen">
  <div class="app flex min-h-screen">
    <!-- üß≠ Sidebar -->
    <aside class="admin-sidebar">
      <%- include('../partials/adminSidebar') %>
    </aside>


    <!-- Main Section -->
    <main class="admin-main flex-1 p-8">
      <!-- üîù Topbar -->
      <header class="admin-topbar mb-8">
        <%- include('../partials/adminTopbar') %>
      </header>
<!-- ‚úÖ Success Message -->
<div id="saveMessage"
  style="display:none; opacity:0; transition:opacity 0.3s ease;"
  class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-100 border border-green-300 text-green-700 px-4 py-2 rounded-lg shadow-md z-50">
  ‚úÖ Exam settings saved successfully!
</div>


      <!-- üß© Final Exam Builder -->
      <section class="bg-white p-8 rounded-2xl shadow-md border border-[#f3e5db] max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-3xl font-bold text-[#4a2e05] flex items-center gap-2">
            üß† Final Exam for <%= course.title %>
          </h2>
          <a href="/admin/courses/<%= course._id %>/view"
             class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-[#4a2e05] font-medium transition">
             ‚¨Ö Back
          </a>
        </div>

 <!-- üß© Final Exam Builder -->
<section class="bg-white p-8 rounded-2xl shadow-md border border-[#f3e5db] max-w-4xl mx-auto">

  <!-- üìú Exam Rules & Settings -->
  <div class="mb-8 border-b pb-6">
    <h3 class="text-2xl font-semibold mb-3 text-[#4a2e05]">üìò Exam Settings</h3>
    
    <form action="/admin/courses/<%= course._id %>/final-exam/settings" method="POST" class="grid grid-cols-2 gap-4">
      
      <!-- üïí Time Limit -->
      <div class="col-span-2 sm:col-span-1">
        <label class="block font-semibold mb-1">Time Limit (minutes)</label>
        <input 
          type="number" 
          name="timeLimit" 
          value="<%= course.examSettings.timeLimit %>"
          class="w-full border border-gray-300 rounded-lg p-2"
          min="1"
        >
      </div>

      <!-- üìù Description -->
      <div class="col-span-2">
        <label class="block font-semibold mb-1">Exam Description / Instructions</label>
        <textarea 
          name="description" 
          rows="3"
          class="w-full border border-gray-300 rounded-lg p-2"
          placeholder="Write exam rules or instructions here..."
        ><%= course.examSettings.description %></textarea>
      </div>

      <!-- üíæ Save Button -->
      <div class="col-span-2 flex justify-end mt-4">
        <button 
          type="submit" 
          class="px-4 py-2 rounded-lg bg-[#f97316] hover:bg-[#ea580c] text-white font-medium"
        >
          üíæ Save Exam Settings
        </button>
      </div>
    </form>
  </div>

        <!-- List existing questions -->
        <% if (quiz && quiz.questions.length > 0) { %>
          <div class="space-y-4">
            <% quiz.questions.forEach((q, i) => { %>
              <div class="border border-gray-200 rounded-lg p-4 bg-[#fff9f5]">
                <p class="font-semibold">Question <%= i + 1 %>: <%= q.questionText %></p>
                <ul class="list-disc list-inside text-sm text-gray-700 mt-1">
                  <% q.options.forEach((opt) => { %>
                    <li><%= opt %></li>
                  <% }) %>
                </ul>
                <p class="text-green-600 mt-1">‚úÖ Correct: <%= q.correctAnswer %></p>

                <div class="flex gap-3 mt-3">
                  <!-- ‚úèÔ∏è Edit -->
                  <button class="text-blue-500 hover:text-blue-700 font-medium"
                          onclick="openEditModal('<%= q.questionText %>', `<%= q.options.join('\\n') %>`, '<%= q.correctAnswer %>', <%= i %>)">
                    ‚úèÔ∏è Edit
                  </button>

                  <!-- üóëÔ∏è Delete -->
                  <form action="/admin/courses/<%= course._id %>/final-exam/delete/<%= i %>" method="POST"
                        onsubmit="return confirm('Are you sure you want to delete this question?');">
                    <button type="submit" class="text-red-500 hover:text-red-700 font-medium">üóë Delete</button>
                  </form>
                </div>
              </div>
            <% }) %>
          </div>
        <% } else { %>
          <p class="text-gray-500 italic mb-6">No questions yet. Add one below.</p>
        <% } %>

        <div class="flex justify-end mt-6">
          <a href="#" id="addExamQuestionBtn"
             class="px-4 py-2 rounded-lg bg-[#f97316] hover:bg-[#ea580c] text-white transition">
             ‚ûï Add Question
          </a>
        </div>
      </section>
    </main>
  </div>

  <!-- ü™Ñ Add Question Modal -->
  <div id="finalExamModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-white rounded-2xl p-6 w-[600px] shadow-lg">
      <h3 class="text-xl font-semibold mb-4 text-[#4a2e05]">Add Final Exam Question</h3>

      <form action="/admin/courses/<%= course._id %>/final-exam" method="POST" class="space-y-3" id="finalExamForm">
        <label class="block font-semibold">Question:</label>
        <textarea name="questionText" rows="2" required
          class="w-full border border-gray-300 rounded-lg p-2"></textarea>

        <label class="block font-semibold">Options (one per line):</label>
        <textarea name="options" id="examOptions" rows="3" required
          class="w-full border border-gray-300 rounded-lg p-2"
          placeholder="Write each option on a new line..."></textarea>

        <label class="block font-semibold">Correct Answer:</label>
        <select name="correctAnswer" id="examCorrectSelect"
          class="w-full border border-gray-300 rounded-lg p-2 mb-2">
          <option value="">-- Add options first --</option>
        </select>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button" id="cancelExamQuestion"
            class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancel</button>
          <button type="submit"
            class="px-4 py-2 rounded-lg bg-[#f97316] hover:bg-[#ea580c] text-white">Add</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ‚úèÔ∏è Edit Question Modal -->
  <div id="editExamModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-white rounded-2xl p-6 w-[600px] shadow-lg">
      <h3 class="text-xl font-semibold mb-4 text-[#4a2e05]">Edit Question</h3>

      <form id="editExamForm" method="POST" class="space-y-3">
        <label class="block font-semibold">Question:</label>
        <textarea name="questionText" id="editQuestionText" rows="2"
          class="w-full border border-gray-300 rounded-lg p-2"></textarea>

        <label class="block font-semibold">Options (one per line):</label>
        <textarea name="options" id="editOptions" rows="3"
          class="w-full border border-gray-300 rounded-lg p-2"></textarea>

        <label class="block font-semibold">Correct Answer:</label>
        <select name="correctAnswer" id="editCorrectSelect"
          class="w-full border border-gray-300 rounded-lg p-2 mb-2">
          <option value="">-- Add options first --</option>
        </select>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button" id="cancelEditExam"
            class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancel</button>
          <button type="submit"
            class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- üß† JavaScript -->
   <script>
/* ============================
   üß† Add / Edit Question Logic
============================ */
const examModal = document.getElementById('finalExamModal');
const addExamBtn = document.getElementById('addExamQuestionBtn');
const cancelExamBtn = document.getElementById('cancelExamQuestion');
const examOptionsField = document.getElementById('examOptions');
const examCorrectSelect = document.getElementById('examCorrectSelect');
const examForm = document.getElementById('finalExamForm');

const editModal = document.getElementById('editExamModal');
const editForm = document.getElementById('editExamForm');
const editQuestionText = document.getElementById('editQuestionText');
const editOptionsField = document.getElementById('editOptions');
const editCorrectSelect = document.getElementById('editCorrectSelect');
const cancelEditBtn = document.getElementById('cancelEditExam');

// üß© Add Question Modal
addExamBtn.addEventListener('click', () => {
  examModal.classList.remove('hidden');
  examForm.reset();
  examCorrectSelect.innerHTML = '<option value="">-- Add options first --</option>';
});

cancelExamBtn.addEventListener('click', () => {
  examModal.classList.add('hidden');
  examForm.reset();
});

// Auto update correct dropdown for add modal
examOptionsField.addEventListener('input', () => {
  const options = examOptionsField.value.split('\n').map(o => o.trim()).filter(Boolean);
  examCorrectSelect.innerHTML = '';
  if (options.length === 0) {
    examCorrectSelect.innerHTML = '<option value="">-- Add options first --</option>';
    return;
  }
  options.forEach((opt, i) => {
    const option = document.createElement('option');
    option.value = opt;
    option.textContent = opt;
    if (i === 0) option.selected = true;
    examCorrectSelect.appendChild(option);
  });
});

// ‚úèÔ∏è Edit Question Modal
function openEditModal(question, options, correct, index) {
  editModal.classList.remove('hidden');
  editForm.action = `/admin/courses/<%= course._id %>/final-exam/edit/${index}`;
  editQuestionText.value = question;
  editOptionsField.value = options;

  const opts = options.split('\n').map(o => o.trim()).filter(Boolean);
  editCorrectSelect.innerHTML = '';
  opts.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt;
    option.textContent = opt;
    if (opt === correct) option.selected = true;
    editCorrectSelect.appendChild(option);
  });
}

cancelEditBtn.addEventListener('click', () => {
  editModal.classList.add('hidden');
  editForm.reset();
});

editOptionsField.addEventListener('input', () => {
  const opts = editOptionsField.value.split('\n').map(o => o.trim()).filter(Boolean);
  editCorrectSelect.innerHTML = '';
  if (opts.length === 0) {
    editCorrectSelect.innerHTML = '<option value="">-- Add options first --</option>';
    return;
  }
  opts.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt;
    option.textContent = opt;
    editCorrectSelect.appendChild(option);
  });
});


/* ============================
   üíæ Save Final Exam Settings (AJAX)
============================ */
console.log("‚úÖ Final Exam script loaded!");

const form = document.querySelector('form[action*="final-exam/settings"]');

if (form) {
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const data = {
      timeLimit: form.timeLimit ? form.timeLimit.value : 0,
      description: form.description ? form.description.value : ""
    };

    try {
      const res = await fetch(form.action, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      console.log("Response:", result);

      if (result.success) {
        showToast("‚úÖ Exam settings saved successfully!", "green");
      } else {
        showToast("‚ùå Failed to save exam settings.", "red");
      }
    } catch (err) {
      showToast("‚ùå Error saving exam settings.", "red");
      console.error(err);
    }
  });
}


/* ============================
   üß© Toast Notification Function
============================ */
function showToast(message, color = "green") {
  // Create a new toast element
  const toast = document.createElement("div");
  toast.textContent = message;

  // Apply style directly for guaranteed visibility
  toast.style.position = "fixed";
  toast.style.top = "90px";
  toast.style.left = "50%";
  toast.style.transform = "translateX(-50%)";
  toast.style.backgroundColor = color === "green" ? "#dcfce7" : "#fee2e2";
  toast.style.border = `2px solid ${color === "green" ? "#22c55e" : "#ef4444"}`;
  toast.style.color = color === "green" ? "#166534" : "#991b1b";
  toast.style.padding = "10px 20px";
  toast.style.borderRadius = "8px";
  toast.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
  toast.style.zIndex = "9999";
  toast.style.fontWeight = "600";
  toast.style.transition = "opacity 0.3s ease";
  toast.style.opacity = "0";

  // Add it to the page
  document.body.appendChild(toast);

  // Fade in
  requestAnimationFrame(() => {
    toast.style.opacity = "1";
  });

  // Fade out + remove after 3 seconds
  setTimeout(() => {
    toast.style.opacity = "0";
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

</script>

</body>
</html>
