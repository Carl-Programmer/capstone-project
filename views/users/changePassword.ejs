<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chabalingo • Change Password</title>

  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/profile.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="/js/main.js"></script>

  <style>
    .pill {
      position: relative;
      margin-bottom: 1.5rem;
    }

    .toggle-eye {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #5A3F20;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s ease;
    }

    .toggle-eye:hover {
      opacity: 1;
    }

    .alert {
      text-align: center;
      padding: 8px 14px;
      border-radius: 8px;
      margin-bottom: 14px;
      font-weight: 600;
      animation: fadein 0.3s ease;
    }

    .alert.success {
      background: #d9f7d9;
      color: #206620;
      border: 1px solid #a0e2a0;
    }

    .alert.error {
      background: #fddddd;
      color: #831b1b;
      border: 1px solid #f3a0a0;
    }

    @keyframes fadein {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Password strength message styling */
    .strength-info {
      font-size: 0.8rem;
      font-weight: 500;
      margin-top: -1rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }
  </style>
</head>

<body>
  <div class="app">
    <%- include('../partials/_sidebar') %>

    <main class="main">
      <%- include('../partials/_topbar') %>

      <div class="wrap">
        <section class="shell">
          <div class="panel max-w-md mx-auto">
            <h2>Change Password</h2>

            <% if (message) { %>
              <div id="alertBox" class="alert <%= message.includes('✅') ? 'success' : 'error' %>">
                <%= message %>
              </div>
            <% } %>

            <form action="/users/change-password" method="POST" class="form">
              <div class="pill">
                <input type="password" id="currentPassword" name="currentPassword" placeholder="Current Password" required>
                <i class="fas fa-eye toggle-eye" id="toggleCurrent"></i>
              </div>

              <div class="pill">
                <input type="password" id="newPassword" name="newPassword" placeholder="New Password" required minlength="6">
                <i class="fas fa-eye toggle-eye" id="toggleNew"></i>
              </div>

              <div class="pill">
                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm New Password" required minlength="6">
                <i class="fas fa-eye toggle-eye" id="toggleConfirm"></i>
              </div>

              <!-- Password strength feedback here -->
              <div id="strengthInfo" class="strength-info text-center"></div>

              <div class="actions">
                <button type="button" class="btn secondary" onclick="window.history.back()">Cancel</button>
                <button type="submit" class="btn" id="saveBtn">Save</button>
              </div>
            </form>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ===============================
    // Toggle password visibility
    // ===============================
    const toggles = [
      { input: 'currentPassword', icon: 'toggleCurrent' },
      { input: 'newPassword', icon: 'toggleNew' },
      { input: 'confirmPassword', icon: 'toggleConfirm' },
    ];

    toggles.forEach(t => {
      const input = document.getElementById(t.input);
      const icon = document.getElementById(t.icon);

      icon.addEventListener('click', () => {
        const isHidden = input.type === 'password';
        input.type = isHidden ? 'text' : 'password';
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
      });
    });

    // ===============================
    // Password strength checker
    // ===============================
    document.addEventListener("DOMContentLoaded", () => {
      const newPassword = document.getElementById("newPassword");
      const confirmPassword = document.getElementById("confirmPassword");
      const saveBtn = document.getElementById("saveBtn");
      const strengthInfo = document.getElementById("strengthInfo");

      // Disable save initially
      saveBtn.disabled = true;
      saveBtn.style.opacity = "0.6";
      saveBtn.style.cursor = "not-allowed";

      const checkStrength = (val) => {
        let score = 0;
        if (val.length >= 8) score++;
        if (/[A-Z]/.test(val)) score++;
        if (/[a-z]/.test(val)) score++;
        if (/[0-9]/.test(val)) score++;
        if (/[^A-Za-z0-9]/.test(val)) score++;
        return score;
      };

      const updateStrength = () => {
        const val = newPassword.value;
        const confirmVal = confirmPassword.value;
        const strength = checkStrength(val);

        if (!val) {
          strengthInfo.textContent = "";
          saveBtn.disabled = true;
          saveBtn.style.opacity = "0.6";
          saveBtn.style.cursor = "not-allowed";
          return;
        }

        if (strength <= 2) {
          strengthInfo.textContent = "Weak password – add uppercase letters, numbers, and symbols.";
          strengthInfo.style.color = "#ef4444";
          saveBtn.disabled = true;
          saveBtn.style.opacity = "0.6";
          saveBtn.style.cursor = "not-allowed";
        } else if (strength <= 4) {
          strengthInfo.textContent = "Medium password – try adding special characters to strengthen it.";
          strengthInfo.style.color = "#eab308";
          saveBtn.disabled = true;
          saveBtn.style.opacity = "0.6";
          saveBtn.style.cursor = "not-allowed";
        } else {
          strengthInfo.textContent = "Strong password – ready to save!";
          strengthInfo.style.color = "#22c55e";

          // Enable only if confirm password matches
          if (val === confirmVal && confirmVal.length > 0) {
            saveBtn.disabled = false;
            saveBtn.style.opacity = "1";
            saveBtn.style.cursor = "pointer";
          } else {
            saveBtn.disabled = true;
            saveBtn.style.opacity = "0.6";
            saveBtn.style.cursor = "not-allowed";
          }
        }
      };

      newPassword.addEventListener("input", updateStrength);
      confirmPassword.addEventListener("input", updateStrength);
    });

    // ===============================
    // Fade out alert
    // ===============================
    setTimeout(() => {
      const alert = document.getElementById('alertBox');
      if (alert) {
        alert.style.opacity = '0';
        alert.style.transition = 'opacity 0.5s ease';
        setTimeout(() => alert.remove(), 500);
      }
    }, 4000);
  </script>
</body>
</html>
